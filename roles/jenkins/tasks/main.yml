# install jdk 1.8
- name: Update the software package repository
  yum:
    name: '*'
    update_cache: yes


- name: Install dependencies
  package:
    name: "{{ item }}"
    state: latest
  loop:
    - java-1.8.0-openjdk
    - git
    - texlive-latex
    - wget
    - nginx

- name: Download jenkins repo
  command: wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo

- name: Import jenkins CI key
  rpm_key:
    key: http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
    state: present

- name: Update the software package repository
  yum:
    name: '*'
    update_cache: yes

- name: Install jenkins
  yum:
    name: jenkins
    state: latest
    update_cache: yes




- name: Allow port 8080
  shell: iptables -I INPUT -p tcp --dport 8080 -m state --state NEW,ESTABLISHED -j ACCEPT

# sudo cat **/var/lib/jenkins/secrets/initialAdminPassword**
# SET NGINX CONFIGURATION TO nginx.conf:
# location / {
#            proxy_pass  http://127.0.0.1:8080;
#        }

#sudo setenforce 0
#

- name: Enable services to run at boot time
  service:
    name: {{ itemtostart }}
    enabled: yes
    masked: no
  loop:
    - nginx
    - jenkins

- name: start the services
  service:
    name: {{ itemtostart }}
    state: started
  loop:
    - nginx
    - jenkins


- name: Print key
  shell: cat < /var/lib/jenkins/secrets/initialAdminPassword



# 
# yum remove java
# yum install java-1.8.0-openjdk

# install jenkins
#
# sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo
# sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key
# sudo yum install jenkins

# install git
# https://luvunix.wordpress.com/2017/10/03/jenkins-deployment-using-ansible/

# sudo cat **/var/lib/jenkins/secrets/initialAdminPassword**
# SET NGINX CONFIGURATION TO nginx.conf:
# location / {
#            proxy_pass  http://127.0.0.1:8080;
#        }

#sudo setenforce 0
#  sudo chown ansible nginx.conf to replace the nginx file in the destination server



- name: Add the user 'jenkins' with a bash shell, appending to group 'wheel'
  user:
    name: jenkins
    shell: /bin/bash
    groups: devops
    append: yes
    password: Jenkins@1234

- name: Create a 2048-bit SSH key for user jenkins in ~jenkins/.ssh/id_rsa
  user:
    name: jenkins
    generate_ssh_key: yes
    ssh_key_bits: 2048
    ssh_key_file: .ssh/id_rsa

- lineinfile:
    path: /etc/sudoers
    state: present
    regexp: '^# %wheel'
    line: 'jenkins ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'